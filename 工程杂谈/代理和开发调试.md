# 前端代理和开发调试方案

## 前言
> 本文是基于团队内一位小姐姐[ArwenChan](https://github.com/ArwenChan)的文章基础上完善而来

### 一、混合开发调试

#### 1.1 真机连接本地开发环境（开发时调试）
1. devServer 不需要设置 host 等（在 whistle rules 里面设置即可），但是需要设置 `disableHostCheck`:

	```
	devServer: {
		disableHostCheck: true
	}
	```
2. 在 whistle 中设置 rules:

	```
	www.test.com/hello/basepage localhost:8080/basepage
	```
有时候 `localhost` 不生效的话，尝试用本机IP代替。
**注意**：上面的例子，`www.test.com/hello/basepage`被代理后，本地 vue router 解析到的 path 仍然是 `hello/basepage` 而不是 `basepage`。
3. 给移动端 wifi 设置代理，代理地址为 `{本机IP}:8899`
4. 如果移动端是请求https，参照[这里](http://wproxy.org/whistle/webui/https.html)进行设置。

#### 1.2 真机连接本机（bug调试）
1. 设置production环境的publicPath，然后 build。
2. 在 whistle 中代理 html 和各类静态资源：
	```
	www.test.com/hello/basepage file://D:/projects/project-name/dist/index.html
	www.test.com/your-public-path file://D:/projects/project-name/dist
	```
3. 使用调试工具：
whistle 自带的 weinre 和 log。当然手机要先代理到 whistle。

	```
	www.test.com weinre://test   
	# 像浏览器的 devtools 那样查看和修改页面结构
	www.test.com log://test  
	# 可以在 network 的log栏查看页面的log，也可以利用操作值注入自定义 js： log://{test.js}。
	# 如果你喜欢将调试信息直接输出在手机屏幕上，可以注入微信的vConsole.js，但不可以和weinre一起用
	```

weinre:
![weinre.gif](https://i.loli.net/2019/03/05/5c7e17185389c.gif)

log: 
![FnjMsJAaJffOLKkY9mpNRHttQ9ck.gif](https://i.loli.net/2019/03/05/5c7e187bcb803.gif)

如果你嫌弃weinre用的不如devtools顺手，可以看看[m-console](https://github.com/fwon/m-console)。
利用chrome inspect 连接 android，可以[直接使用devTools](https://developers.google.com/web/tools/chrome-devtools/remote-debugging/)，只是连接设置麻烦些。相应的，safari 也可以直接连接 iphone 进行调试。

#### 1.3 模拟器调试（无真机bug调试）
真机调试应该始终作为首要bug调试方式。有时候遇到由原生系统版本引起的bug，又刚好没有对应真机，可以尝试模拟器调试。
ios模拟器必须依赖mac，PC用户最多可以远程连接mac上的模拟器，这个方法需要PC安装 Visual Studio，[与mac连接](https://docs.microsoft.com/zh-cn/xamarin/ios/get-started/installation/windows/connecting-to-mac/)。然后启动ios模拟器即可调用远程的ios模拟器。
下面说一下 Android 模拟器调试，Android 模拟器有专门的web view tester 可以方便测试 webview问题。
1. 下载 android studio，创建 AVD。
2. 启动模拟器，浏览器打开`http://{your-ip}:8899/cgi-bin/rootca`下载 whistle 证书。这里最好给两个凭据用途都安装一次。
![](https://pic4.zhimg.com/80/v2-5c2ccce4307c8e98f3bfbd568a3755af_hd.jpg)
![](https://pic4.zhimg.com/80/v2-a644a5ab6dd23671c4b929a727d6748f_hd.jpg)
3. 设置代理：进入设置=>wifi=>**长按**连接的wifi，选择“修改网络”，proxy：{your-ip}，port：8899。
4. 打开浏览器请求即可看到 whistle 的抓包记录。

### 1.4 PC开发调试
PC端的部分多数是php写的，遇到有bug或者新需求需要调整页面的情况（重构除外），就需要分两个部分处理。
比如以 24 为测试机：
1. js 和 css 代理到本地，本地修改，24上看效果。下面是示例 whistle rules：

	```
	172.17.20.24 www.ekwing.com
	www.ekwing.com/resource/exam file://D:/svn-projects/exam_reback/resource
	```
2. html 需要 ftp 上传到24。可以利用vscode的插件 ftp-simple，配置好之后，通过右键菜单就可以上传文件到服务器。下面是示例的 ftp-simple 的配置：

	```
	[
		{
			"name": "24-stat",
			"host": "172.17.20.24",
			"port": 22,
			"type": "sftp",
			"username": "root",
			"password": "*****", # 对应服务器登陆密码
			"path": "/home/www/ekwing/views/html/stat", # 对应所属项目的html目录
			"autosave": false,
			"confirm": true
		}
	]
	```